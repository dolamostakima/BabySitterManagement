@{
    ViewData["Title"] = "Admin - Reviews";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3 class="mb-3">Admin: Reviews Moderation</h3>

<div class="card p-3 mb-3">
    <div class="row g-2">
        <div class="col-md-3">
            <select id="approved" class="form-select">
                <option value="">All</option>
                <option value="true">Approved</option>
                <option value="false">Pending</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="hidden" class="form-select">
                <option value="">All</option>
                <option value="false">Visible</option>
                <option value="true">Hidden</option>
            </select>
        </div>
        <div class="col-md-4">
            <input id="query" class="form-control" placeholder="Search name/email/comment" />
        </div>
        <div class="col-md-2">
            <button id="btnLoad" class="btn btn-primary w-100">Load</button>
        </div>
    </div>
</div>

<div id="msg"></div>
<div id="list" class="card p-3 shadow-sm">Loading...</div>

@section Scripts {
    <script>
        const token = (localStorage.getItem("jwt_token") || "").replace(/^"|"$/g,"");

        function api(method,url,body){
          return $.ajax({
            url, method,
            contentType:"application/json",
            headers:{ Authorization:`Bearer ${token}` },
            data: body? JSON.stringify(body):null
          });
        }
        function showErr(t){ $("#msg").html(`<div class="alert alert-danger">${t}</div>`); }
        function showOk(t){ $("#msg").html(`<div class="alert alert-success">${t}</div>`); }

        function load(){
          const approved = $("#approved").val();
          const hidden = $("#hidden").val();
          const query = $("#query").val();

          let url = `/api/admin/reviews?page=1&pageSize=50`;
          if(approved!=="") url += `&approved=${approved}`;
          if(hidden!=="") url += `&hidden=${hidden}`;
          if(query) url += `&query=${encodeURIComponent(query)}`;

          api("GET", url)
            .done(res=>{
              const items = res.items||[];
              if(!items.length){ $("#list").html(`<div class="text-muted">No reviews found.</div>`); return; }

              const html = items.map(r=>`
                <div class="border rounded p-3 mb-2">
                  <div class="d-flex justify-content-between">
                    <div>
                      <b>Rating:</b> ${r.rating}/5
                      <span class="ms-2 badge bg-${r.isApproved?'success':'warning'}">${r.isApproved?'Approved':'Pending'}</span>
                      ${r.isHidden?`<span class="ms-1 badge bg-secondary">Hidden</span>`:""}
                    </div>
                    <div class="small text-muted">${(r.createdAt||"").substring(0,10)}</div>
                  </div>

                  <div class="mt-2">${r.comment || "<span class='text-muted'>No comment</span>"}</div>

                  <div class="mt-2 small text-muted">
                    <b>Parent:</b> ${r.parent.fullName} (${r.parent.email}) <br/>
                    <b>Sitter:</b> ${r.sitter.fullName} (${r.sitter.email})
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-sm btn-success" onclick="decision(${r.id}, true, false)">Approve</button>
                    <button class="btn btn-sm btn-secondary" onclick="decision(${r.id}, ${r.isApproved ? "true" : "false"}, true)">Hide</button>
                    <button class="btn btn-sm btn-outline-dark" onclick="decision(${r.id}, false, false)">Reject (keep pending)</button>
                  </div>
                </div>
              `).join("");

              $("#list").html(html);
            })
            .fail(x=> showErr(x.responseText || "Load failed"));
        }

        function decision(id, approve, hide){
          api("POST", `/api/admin/reviews/${id}/decision`, { approve, hide })
            .done(()=>{ showOk("Updated"); load(); })
            .fail(x=> showErr(x.responseText || "Update failed"));
        }

        $("#btnLoad").click(load);
        $(document).ready(load);
    </script>
}